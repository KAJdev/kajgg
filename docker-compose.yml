services:
  traefik:
    build:
      context: ./traefik
    ports:
      - "80:80"
    environment:
      - CHAT_API_URL=http://chat-api:3002
      - CHAT_GATEWAY_URL=http://chat-gateway:3003
      - MEDIA_PROXY_URL=http://media-proxy:3004
    networks:
      - chat-network

  chat-api:
    build:
      context: ./chat-api
      dockerfile: Dockerfile
    environment:
      - MODE=api
      - ENV=staging
      - PORT=3002
      - MONGO_URL=mongodb://admin:admin@chat-db:27017/chat?authSource=admin
      - EMBEDDINGS_URL=http://embeddings:8000
      - REDIS_URL=redis://:password@chat-redis:6379/0
      # r2 creds (s3-compatible)
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET=${R2_BUCKET}
      - R2_PUBLIC_BASE_URL=${R2_PUBLIC_BASE_URL}
    depends_on:
      - chat-db
      - chat-redis
    networks:
      - chat-network
    labels:
      - "traefik.enable=true"
      - "traefik.chat-api.insecure=true"
      - "traefik.http.routers.chat-api.rule=Host(`localhost`) && PathPrefix(`/api`)"
      - "traefik.http.services.chat-api.loadbalancer.server.port=3002"
      - "traefik.http.middlewares.chat-api-stripprefix.stripprefix.prefixes=/api"
      - "traefik.http.routers.chat-api.middlewares=chat-api-stripprefix"
    develop:
      watch:
        - action: rebuild
          path: ./chat-api

  chat-gateway:
    build:
      context: ./chat-api
      dockerfile: Dockerfile
    environment:
      - MODE=gateway
      - ENV=staging
      - PORT=3003
      - MONGO_URL=mongodb://admin:admin@chat-db:27017/chat?authSource=admin
      - REDIS_URL=redis://:password@chat-redis:6379/0
      # r2 creds (s3-compatible)
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET=${R2_BUCKET}
      - R2_PUBLIC_BASE_URL=${R2_PUBLIC_BASE_URL}
    depends_on:
      - chat-db
      - chat-redis
    networks:
      - chat-network
    labels:
      - "traefik.enable=true"
      - "traefik.chat-gateway.insecure=true"
      - "traefik.http.routers.chat-gateway.rule=Host(`localhost`) && PathPrefix(`/gateway`)"
      - "traefik.http.services.chat-gateway.loadbalancer.server.port=3003"
      - "traefik.http.middlewares.chat-gateway-stripprefix.stripprefix.prefixes=/gateway"
      - "traefik.http.routers.chat-gateway.middlewares=chat-gateway-stripprefix"
    develop:
      watch:
        - action: rebuild
          path: ./chat-api

  media-proxy:
    build:
      context: ./media-proxy
      dockerfile: Dockerfile
    environment:
      - PORT=3004
      - ENV=staging
      # - ALLOWED_PORTS=80,443
      # - MAX_BYTES=0
    networks:
      - chat-network
    develop:
      watch:
        - action: rebuild
          path: ./media-proxy

  # embeddings:
  #   build:
  #     context: ./embeddings
  #     dockerfile: Dockerfile
  #   environment:
  #     - ENV=staging
  #     - MODEL_ID=encord-team/ebind-full
  #     - HOST=0.0.0.0
  #     - PORT=8000
  #     - MAX_INFLIGHT=2
  #   networks:
  #     - chat-network
  #   ports:
  #     - "8000:8000"

  chat-db:
    image: mongo:latest
    attach: false
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin
      - MONGO_INITDB_DATABASE=chat
    networks:
      - chat-network
    volumes:
      - chat-db-data:/data/db
    command: mongod --auth

  chat-redis:
    image: redis:latest
    attach: false
    networks:
      - chat-network
    volumes:
      - chat-redis-data:/data
    environment:
      - REDIS_PASSWORD=password
    command: ["redis-server", "--requirepass", "password"]

networks:
  chat-network:
    driver: bridge

volumes:
  chat-db-data:
    driver: local
  chat-redis-data:
    driver: local
